<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Encrypted Server Name Indication for TLS 1.3</title>
<meta content="Eric Rescorla" name="author">
<meta content="Kazuho Oku" name="author">
<meta content="Nick Sullivan" name="author">
<meta content="Christopher A. Wood" name="author">
<meta content="
       This document defines a simple mechanism for encrypting the
Server Name Indication for TLS 1.3. 
    " name="description">
<meta content="xml2rfc 2.37.3" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-ietf-tls-esni-latest" name="ietf.draft">
<link href="draft-ietf-tls-esni.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@import url('https://martinthomson.github.io/i-d-template/fonts.css');

html {
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --small-font-size: 14.5px;
}
body {
  max-width: 624px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
#title {
  padding: 1em 0 0.2em;
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1, h2, h3 {
  font-size: 22px;
  line-height: 26px;
}
h4, h5, h6 {
  font-size: 18px;
  line-height: 22px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p, #abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 18px;
  line-height: 24px;
}
p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href].selfRef {
  color: var(--text-color);
}
a[href] {
  color: var(--link-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px 'Oxygen Mono', monospace;
}
pre {
  border: 1px solid var(--line-color);
  line-height: 17px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  pre {
    display: inline-block;
    overflow-x: auto;
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  pre + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #eee;
}
tr:nth-child(2n) > td {
  background-color: var(--background-color);
}
tr:nth-child(2n+1) > td {
  background-color: var(--highlight-color);
}
thead+tbody tr:nth-child(2n) > td {
  background-color: var(--highlight-color);
}
thead+tbody tr:nth-child(2n+1) > td {
  background-color: var(--background-color);
}
table caption {
  font-style: italic;
  margin: 0.3em 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  visibility: hidden;
  user-select: none;
}
a.pilcrow[href] { color: #ddd; }
a.pilcrow[href]:hover { text-decoration: none; }
@media screen {
  :hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 8em;
}
#identifiers dt {
  width: var(--identifier-width);
  margin: 0;
  clear: left;
  float: left;
  text-align: right;
}
#identifiers dd {
  margin: 0 0 0 calc(1em + var(--identifier-width));
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    column-count: 2;
    column-gap: 20px;
  }
  .index ul ul {
    column-count: 1;
    column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 600px) {
  #authors-addresses {
    display: relative;
    padding: 32px 0 0;
    column-count: 2;
    column-gap: 20px;
  }
  #name-authors-addresses {
    position: absolute;
    top: 0px;
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
  }
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #b76427;
  background-color: rgba(249, 232, 105, 0.3);
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: rgba(249, 232, 105, 0.3);
  border-radius: 3px;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 953px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 954px) {
  body {
    padding-right: 380px;
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul p, #toc ul li {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  dd {
    page-break-before: avoid;
  }
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
</head>
<body>
<script src="metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">TLS 1.3 SNI Encryption</td>
<td class="right">February 2020</td>
</tr></thead>
<tfoot><tr>
<td class="left">Rescorla, et al.</td>
<td class="center">Expires 26 August 2020</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">tls</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-tls-esni-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2020-02-23" class="published">23 February 2020</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Experimental</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2020-08-26">26 August 2020</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">E. Rescorla</div>
<div class="org">RTFM, Inc.</div>
</div>
<div class="author">
      <div class="author-name">K. Oku</div>
<div class="org">Fastly</div>
</div>
<div class="author">
      <div class="author-name">N. Sullivan</div>
<div class="org">Cloudflare</div>
</div>
<div class="author">
      <div class="author-name">C.A. Wood</div>
<div class="org">Apple, Inc.</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Encrypted Server Name Indication for TLS 1.3</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document defines a simple mechanism for encrypting the
Server Name Indication for TLS 1.3.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 26 August 2020.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2020 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a><a href="#section-toc.1-1.1.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="xref">2</a>.  <a href="#name-conventions-and-definitions" class="xref">Conventions and Definitions</a><a href="#section-toc.1-1.2.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-overview" class="xref">Overview</a><a href="#section-toc.1-1.3.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="xref">3.1</a>.  <a href="#name-topologies" class="xref">Topologies</a><a href="#section-toc.1-1.3.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="xref">3.2</a>.  <a href="#name-sni-encryption" class="xref">SNI Encryption</a><a href="#section-toc.1-1.3.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-encrypted-sni-configuration" class="xref">Encrypted SNI Configuration</a><a href="#section-toc.1-1.4.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-the-encrypted_server_name-e" class="xref">The "encrypted_server_name" extension</a><a href="#section-toc.1-1.5.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-client-behavior" class="xref">Client Behavior</a><a href="#section-toc.1-1.5.2.1.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.5.2.1.2.1">
                    <p id="section-toc.1-1.5.2.1.2.1.1"><a href="#section-5.1.1" class="xref">5.1.1</a>.  <a href="#name-sending-an-encrypted-sni" class="xref">Sending an encrypted SNI</a><a href="#section-toc.1-1.5.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.5.2.1.2.2">
                    <p id="section-toc.1-1.5.2.1.2.2.1"><a href="#section-5.1.2" class="xref">5.1.2</a>.  <a href="#name-handling-the-server-respons" class="xref">Handling the server response</a><a href="#section-toc.1-1.5.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.5.2.1.2.3">
                    <p id="section-toc.1-1.5.2.1.2.3.1"><a href="#section-5.1.3" class="xref">5.1.3</a>.  <a href="#name-authenticating-for-the-publ" class="xref">Authenticating for the public name</a><a href="#section-toc.1-1.5.2.1.2.3.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.5.2.1.2.4">
                    <p id="section-toc.1-1.5.2.1.2.4.1"><a href="#section-5.1.4" class="xref">5.1.4</a>.  <a href="#name-grease-extensions" class="xref">GREASE extensions</a><a href="#section-toc.1-1.5.2.1.2.4.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-client-facing-server-behavi" class="xref">Client-Facing Server Behavior</a><a href="#section-toc.1-1.5.2.2.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="xref">5.3</a>.  <a href="#name-shared-mode-server-behavior" class="xref">Shared Mode Server Behavior</a><a href="#section-toc.1-1.5.2.3.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.5.2.4">
                <p id="section-toc.1-1.5.2.4.1"><a href="#section-5.4" class="xref">5.4</a>.  <a href="#name-split-mode-server-behavior" class="xref">Split Mode Server Behavior</a><a href="#section-toc.1-1.5.2.4.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-compatibility-issues" class="xref">Compatibility Issues</a><a href="#section-toc.1-1.6.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="xref">6.1</a>.  <a href="#name-misconfiguration-and-deploy" class="xref">Misconfiguration and Deployment Concerns</a><a href="#section-toc.1-1.6.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="xref">6.2</a>.  <a href="#name-middleboxes" class="xref">Middleboxes</a><a href="#section-toc.1-1.6.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-security-considerations" class="xref">Security Considerations</a><a href="#section-toc.1-1.7.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="xref">7.1</a>.  <a href="#name-why-is-cleartext-dns-ok" class="xref">Why is cleartext DNS OK?</a><a href="#section-toc.1-1.7.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="xref">7.2</a>.  <a href="#name-optional-record-digests-and" class="xref">Optional Record Digests and Trial Decryption</a><a href="#section-toc.1-1.7.2.2.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a href="#section-7.3" class="xref">7.3</a>.  <a href="#name-encrypting-other-extensions" class="xref">Encrypting other Extensions</a><a href="#section-toc.1-1.7.2.3.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.4">
                <p id="section-toc.1-1.7.2.4.1"><a href="#section-7.4" class="xref">7.4</a>.  <a href="#name-related-privacy-leaks" class="xref">Related Privacy Leaks</a><a href="#section-toc.1-1.7.2.4.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.5">
                <p id="section-toc.1-1.7.2.5.1"><a href="#section-7.5" class="xref">7.5</a>.  <a href="#name-comparison-against-criteria" class="xref">Comparison Against Criteria</a><a href="#section-toc.1-1.7.2.5.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.7.2.5.2.1">
                    <p id="section-toc.1-1.7.2.5.2.1.1"><a href="#section-7.5.1" class="xref">7.5.1</a>.  <a href="#name-mitigate-against-replay-att" class="xref">Mitigate against replay attacks</a><a href="#section-toc.1-1.7.2.5.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.5.2.2">
                    <p id="section-toc.1-1.7.2.5.2.2.1"><a href="#section-7.5.2" class="xref">7.5.2</a>.  <a href="#name-avoid-widely-deployed-share" class="xref">Avoid widely-deployed shared secrets</a><a href="#section-toc.1-1.7.2.5.2.2.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.5.2.3">
                    <p id="section-toc.1-1.7.2.5.2.3.1"><a href="#section-7.5.3" class="xref">7.5.3</a>.  <a href="#name-prevent-sni-based-dos-attac" class="xref">Prevent SNI-based DoS attacks</a><a href="#section-toc.1-1.7.2.5.2.3.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.5.2.4">
                    <p id="section-toc.1-1.7.2.5.2.4.1"><a href="#section-7.5.4" class="xref">7.5.4</a>.  <a href="#name-do-not-stick-out" class="xref">Do not stick out</a><a href="#section-toc.1-1.7.2.5.2.4.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.5.2.5">
                    <p id="section-toc.1-1.7.2.5.2.5.1"><a href="#section-7.5.5" class="xref">7.5.5</a>.  <a href="#name-forward-secrecy" class="xref">Forward secrecy</a><a href="#section-toc.1-1.7.2.5.2.5.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.5.2.6">
                    <p id="section-toc.1-1.7.2.5.2.6.1"><a href="#section-7.5.6" class="xref">7.5.6</a>.  <a href="#name-proper-security-context" class="xref">Proper security context</a><a href="#section-toc.1-1.7.2.5.2.6.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.5.2.7">
                    <p id="section-toc.1-1.7.2.5.2.7.1"><a href="#section-7.5.7" class="xref">7.5.7</a>.  <a href="#name-split-server-spoofing" class="xref">Split server spoofing</a><a href="#section-toc.1-1.7.2.5.2.7.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.5.2.8">
                    <p id="section-toc.1-1.7.2.5.2.8.1"><a href="#section-7.5.8" class="xref">7.5.8</a>.  <a href="#name-supporting-multiple-protoco" class="xref">Supporting multiple protocols</a><a href="#section-toc.1-1.7.2.5.2.8.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.7.2.6">
                <p id="section-toc.1-1.7.2.6.1"><a href="#section-7.6" class="xref">7.6</a>.  <a href="#name-misrouting" class="xref">Misrouting</a><a href="#section-toc.1-1.7.2.6.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-iana-considerations" class="xref">IANA Considerations</a><a href="#section-toc.1-1.8.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="xref">8.1</a>.  <a href="#name-update-of-the-tls-extension" class="xref">Update of the TLS ExtensionType Registry</a><a href="#section-toc.1-1.8.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="xref">8.2</a>.  <a href="#name-update-of-the-tls-alert-reg" class="xref">Update of the TLS Alert Registry</a><a href="#section-toc.1-1.8.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="xref">9</a>.  <a href="#name-communicating-sni-and-nonce" class="xref">Communicating SNI and Nonce to Backend Server</a><a href="#section-toc.1-1.9.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="xref">10</a>. <a href="#name-alternative-sni-protection-" class="xref">Alternative SNI Protection Designs</a><a href="#section-toc.1-1.10.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="xref">10.1</a>.  <a href="#name-tls-layer" class="xref">TLS-layer</a><a href="#section-toc.1-1.10.2.1.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.10.2.1.2.1">
                    <p id="section-toc.1-1.10.2.1.2.1.1"><a href="#section-10.1.1" class="xref">10.1.1</a>.  <a href="#name-tls-in-early-data" class="xref">TLS in Early Data</a><a href="#section-toc.1-1.10.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.10.2.1.2.2">
                    <p id="section-toc.1-1.10.2.1.2.2.1"><a href="#section-10.1.2" class="xref">10.1.2</a>.  <a href="#name-combined-tickets" class="xref">Combined Tickets</a><a href="#section-toc.1-1.10.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="xref">10.2</a>.  <a href="#name-application-layer" class="xref">Application-layer</a><a href="#section-toc.1-1.10.2.2.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.10.2.2.2.1">
                    <p id="section-toc.1-1.10.2.2.2.1.1"><a href="#section-10.2.1" class="xref">10.2.1</a>.  <a href="#name-http-2-certificate-frames" class="xref">HTTP/2 CERTIFICATE Frames</a><a href="#section-toc.1-1.10.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="xref">11</a>. <a href="#name-total-client-hello-encrypti" class="xref">Total Client Hello Encryption</a><a href="#section-toc.1-1.11.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="xref">12</a>. <a href="#name-acknowledgements" class="xref">Acknowledgements</a><a href="#section-toc.1-1.12.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="xref">13</a>. <a href="#name-references" class="xref">References</a><a href="#section-toc.1-1.13.1" class="pilcrow">¶</a></p>
<ul class="toc ulEmpty">
<li class="toc ulEmpty" id="section-toc.1-1.13.2.1">
                <p id="section-toc.1-1.13.2.1.1"><a href="#section-13.1" class="xref">13.1</a>.  <a href="#name-normative-references" class="xref">Normative References</a><a href="#section-toc.1-1.13.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.13.2.2">
                <p id="section-toc.1-1.13.2.2.1"><a href="#section-13.2" class="xref">13.2</a>.  <a href="#name-informative-references" class="xref">Informative References</a><a href="#section-toc.1-1.13.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="toc ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-appendix.a" class="xref"></a><a href="#name-authors-addresses" class="xref">Authors' Addresses</a><a href="#section-toc.1-1.14.1" class="pilcrow">¶</a></p>
</li>
</ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">DISCLAIMER: This is very early a work-in-progress design and has not
yet seen significant (or really any) security analysis. It should not
be used as a basis for building production systems.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">Although TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span> encrypts most of the
handshake, including the server certificate, there are several other
channels that allow an on-path attacker to determine the domain name the
client is trying to connect to, including:<a href="#section-1-2" class="pilcrow">¶</a></p>
<ul>
<li id="section-1-3.1">Cleartext client DNS queries.<a href="#section-1-3.1" class="pilcrow">¶</a>
</li>
<li id="section-1-3.2">Visible server IP addresses, assuming the the server is not doing
domain-based virtual hosting.<a href="#section-1-3.2" class="pilcrow">¶</a>
</li>
<li id="section-1-3.3">Cleartext Server Name Indication (SNI) <span>[<a href="#RFC6066" class="xref">RFC6066</a>]</span> in ClientHello messages.<a href="#section-1-3.3" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-1-4">DoH <span>[<a href="#I-D.ietf-doh-dns-over-https" class="xref">I-D.ietf-doh-dns-over-https</a>]</span> and DPRIVE <span>[<a href="#RFC7858" class="xref">RFC7858</a>]</span> <span>[<a href="#RFC8094" class="xref">RFC8094</a>]</span>
provide mechanisms for clients to conceal DNS lookups from network inspection,
and many TLS servers host multiple domains on the same IP address.
In such environments, SNI is an explicit signal used to determine the server's
identity. Indirect mechanisms such as traffic analysis also exist.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">The TLS WG has extensively studied the problem of protecting SNI, but
has been unable to develop a completely generic
solution. <span>[<a href="#I-D.ietf-tls-sni-encryption" class="xref">I-D.ietf-tls-sni-encryption</a>]</span> provides a description
of the problem space and some of the proposed techniques. One of the
more difficult problems is "Do not stick out"
(<span>[<a href="#I-D.ietf-tls-sni-encryption" class="xref">I-D.ietf-tls-sni-encryption</a>]</span>; Section 3.4): if only sensitive/private
services use SNI encryption, then SNI encryption is a signal that
a client is going to such a service. For this reason,
much recent work has focused on
concealing the fact that SNI is being protected. Unfortunately,
the result often has undesirable performance consequences, incomplete
coverage, or both.<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">The design in this document takes a different approach: it assumes
that private origins will co-locate with or hide behind a provider (CDN, app server,
etc.) which is able to activate encrypted SNI (ESNI) for all of the domains
it hosts. Thus, the use of encrypted SNI does not indicate that the
client is attempting to reach a private origin, but only that it is
going to a particular service provider, which the observer could
already tell from the IP address.<a href="#section-1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
"SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span>
when, and only when, they appear in all capitals, as shown here. All TLS notation
comes from <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>; Section 3.<a href="#section-2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="overview">
<section id="section-3">
      <h2 id="name-overview">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-overview" class="section-name selfRef">Overview</a>
      </h2>
<p id="section-3-1">This document is designed to operate in one of two primary topologies
shown below, which we call "Shared Mode" and "Split Mode"<a href="#section-3-1" class="pilcrow">¶</a></p>
<div id="topologies">
<section id="section-3.1">
        <h3 id="name-topologies">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-topologies" class="section-name selfRef">Topologies</a>
        </h3>
<span id="name-shared-mode-topology"></span><div id="shared-mode">
<figure id="figure-1">
          <div class="artwork art-text alignLeft" id="section-3.1-1.1">
<pre>
                +---------------------+
                |                     |
                |   2001:DB8::1111    |
                |                     |
Client &lt;-----&gt;  | private.example.org |
                |                     |
                | public.example.com  |
                |                     |
                +---------------------+
                        Server
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-shared-mode-topology" class="selfRef">Shared Mode Topology</a>
          </figcaption></figure>
</div>
<p id="section-3.1-2">In Shared Mode, the provider is the origin server for all the domains
whose DNS records point to it and clients form a TLS connection directly
to that provider, which has access to the plaintext of the connection.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<span id="name-split-mode-topology"></span><div id="split-mode">
<figure id="figure-2">
          <div class="artwork art-text alignLeft" id="section-3.1-3.1">
<pre>
                +--------------------+       +---------------------+
                |                    |       |                     |
                |   2001:DB8::1111   |       |   2001:DB8::EEEE    |
Client &lt;------------------------------------&gt;|                     |
                | public.example.com |       | private.example.com |
                |                    |       |                     |
                +--------------------+       +---------------------+
                  Client-Facing Server            Backend Server
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-split-mode-topology" class="selfRef">Split Mode Topology</a>
          </figcaption></figure>
</div>
<p id="section-3.1-4">In Split Mode, the provider is <em>not</em> the origin server for private
domains. Rather the DNS records for private domains point to the provider,
and the provider's server relays the connection back to the
backend server, which is the true origin server. The provider does
not have access to the plaintext of the connection.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sni-encryption">
<section id="section-3.2">
        <h3 id="name-sni-encryption">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-sni-encryption" class="section-name selfRef">SNI Encryption</a>
        </h3>
<p id="section-3.2-1">SNI encryption requires that each provider publish a public key and metadata which
is used for SNI encryption for all the domains for which it serves directly or
indirectly (via Split Mode). This document defines the format of the SNI encryption
public key and metadata, referred to as an ESNI configuration, and delegates DNS
publication details to <span>[<a href="#HTTPSSVC" class="xref">HTTPSSVC</a>]</span>, though other delivery
mechanisms are possible. In particular, if some of the clients of a private
server are applications rather than Web browsers, those applications might have
the public key and metadata preconfigured.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">When a client wants to form a TLS connection to any of the domains
served by an ESNI-supporting provider, it sends an "encrypted_server_name"
extension, which contains the true extension encrypted under the
provider's public key. The provider can then decrypt the extension
and either terminate the connection (in Shared Mode) or forward
it to the backend server (in Split Mode).<a href="#section-3.2-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="esni-configuration">
<section id="section-4">
      <h2 id="name-encrypted-sni-configuration">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-encrypted-sni-configuration" class="section-name selfRef">Encrypted SNI Configuration</a>
      </h2>
<p id="section-4-1">SNI Encryption configuration information is conveyed with the following
ESNIConfigs structure.<a href="#section-4-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4-2">
<pre>
    // Copied from TLS 1.3
    struct {
        NamedGroup group;
        opaque key_exchange&lt;1..2^16-1&gt;;
    } KeyShareEntry;

    struct {
        uint16 version;
        opaque contents&lt;1..2^16-1&gt;;
    } ESNIConfig;

    struct {
        opaque public_name&lt;1..2^16-1&gt;;
        KeyShareEntry key;
        CipherSuite cipher_suites&lt;2..2^16-2&gt;;
        uint16 padded_length;
        Extension extensions&lt;0..2^16-1&gt;;
    } ESNIConfigContents;

    ESNIConfig ESNIConfigs&lt;1..2^16-1&gt;;
</pre><a href="#section-4-2" class="pilcrow">¶</a>
</div>
<p id="section-4-3">The ESNIConfigs structure contains one or more ESNIConfig structures in
decreasing order of preference. This allows a server to support multiple
versions of ESNI and multiple sets of ESNI parameters.<a href="#section-4-3" class="pilcrow">¶</a></p>
<p id="section-4-4">The ESNIConfig structure contains the following fields:<a href="#section-4-4" class="pilcrow">¶</a></p>
<dl class="dlParallel" id="section-4-5">
        <dt id="section-4-5.1">version</dt>
<dd id="section-4-5.2">
  The version of the structure. For this specification, that value
SHALL be 0xff03. Clients MUST ignore any ESNIConfig structure with a
version they do not understand.
[[NOTE: This means that the RFC will presumably have a nonzero value.]]<a href="#section-4-5.2" class="pilcrow">¶</a>
</dd>
<dt id="section-4-5.3">contents</dt>
<dd id="section-4-5.4">
  An opaque byte string whose contents depend on the version of the structure.
For this specification, the contents are an ESNIConfigContents structure.<a href="#section-4-5.4" class="pilcrow">¶</a>
</dd>
</dl>
<p id="section-4-6">The ESNIConfigContents structure contains the following fields:<a href="#section-4-6" class="pilcrow">¶</a></p>
<dl class="dlParallel" id="section-4-7">
        <dt id="section-4-7.1">public_name</dt>
<dd id="section-4-7.2">
  The non-empty name of the entity trusted to update these encryption keys.
This is used to repair misconfigurations, as described in
<a href="#handle-server-response" class="xref">Section 5.1.2</a>.<a href="#section-4-7.2" class="pilcrow">¶</a>
</dd>
<dt id="section-4-7.3">key</dt>
<dd id="section-4-7.4">
  The key which can be used by the client to encrypt the SNI. Clients MUST
ignore any ESNIConfig structure with a key using a NamedGroup they do not
support or are unwilling to use.<a href="#section-4-7.4" class="pilcrow">¶</a>
</dd>
<dt id="section-4-7.5">cipher_suites</dt>
<dd id="section-4-7.6">
  The list of cipher suites which can be used by the client to encrypt the SNI.<a href="#section-4-7.6" class="pilcrow">¶</a>
</dd>
<dt id="section-4-7.7">padded_length</dt>
<dd id="section-4-7.8">
  The length to pad the ServerNameList value to prior to encryption.
This value SHOULD be set to the largest ServerNameList the server
expects to support rounded up the nearest multiple of 16. If the
server supports arbitrary wildcard names, it SHOULD set this value to
260. Clients SHOULD reject ESNIConfig as invalid if padded_length is
greater than 260.<a href="#section-4-7.8" class="pilcrow">¶</a>
</dd>
<dt id="section-4-7.9">extensions</dt>
<dd id="section-4-7.10">
  A list of extensions that the client can take into consideration when
generating a Client Hello message. The purpose of the field is to provide room
for additional features in the future. The format is defined in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>;
Section 4.2. The same interpretation rules apply: extensions MAY appear in any
order, but there MUST NOT be more than one extension of the same type in the
extensions block. An extension may be tagged as mandatory by using an extension
type codepoint with the high order bit set to 1. A client which receives a
mandatory extension they do not understand must reject the ESNIConfig content.<a href="#section-4-7.10" class="pilcrow">¶</a>
</dd>
</dl>
<p id="section-4-8">Clients MUST parse the extension list and check for unsupported
mandatory extensions. If an unsupported mandatory extension is
present, clients MUST reject the ESNIConfig value.<a href="#section-4-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="esni-extension">
<section id="section-5">
      <h2 id="name-the-encrypted_server_name-e">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-the-encrypted_server_name-e" class="section-name selfRef">The "encrypted_server_name" extension</a>
      </h2>
<p id="section-5-1">The encrypted SNI is carried in an "encrypted_server_name"
extension, defined as follows:<a href="#section-5-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-2">
<pre>
   enum {
       encrypted_server_name(0xffce), (65535)
   } ExtensionType;
</pre><a href="#section-5-2" class="pilcrow">¶</a>
</div>
<p id="section-5-3">For clients (in ClientHello), this extension contains the following
ClientEncryptedSNI structure:<a href="#section-5-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-4">
<pre>
   struct {
       CipherSuite suite;
       KeyShareEntry key_share;
       opaque record_digest&lt;0..2^16-1&gt;;
       opaque encrypted_sni&lt;0..2^16-1&gt;;
   } ClientEncryptedSNI;
</pre><a href="#section-5-4" class="pilcrow">¶</a>
</div>
<dl class="dlParallel" id="section-5-5">
        <dt id="section-5-5.1">suite</dt>
<dd id="section-5-5.2">
  The cipher suite used to encrypt the SNI.<a href="#section-5-5.2" class="pilcrow">¶</a>
</dd>
<dt id="section-5-5.3">key_share</dt>
<dd id="section-5-5.4">
  The KeyShareEntry carrying the client's public ephemeral key share
used to derive the ESNI key.<a href="#section-5-5.4" class="pilcrow">¶</a>
</dd>
<dt id="section-5-5.5">record_digest</dt>
<dd id="section-5-5.6">
  A cryptographic hash of the ESNIConfig structure from which the ESNI
key was obtained, i.e., from the first byte of "version" to the end
of the structure.  This hash is computed using the hash function
associated with <code>suite</code>.<a href="#section-5-5.6" class="pilcrow">¶</a>
</dd>
<dt id="section-5-5.7">encrypted_sni</dt>
<dd id="section-5-5.8">
  The ClientESNIInner structure, AEAD-encrypted using cipher suite "suite" and
the key generated as described below.<a href="#section-5-5.8" class="pilcrow">¶</a>
</dd>
</dl>
<p id="section-5-6">For servers (in EncryptedExtensions), this extension contains the following
structure:<a href="#section-5-6" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-7">
<pre>
   enum {
       esni_accept(0),
       esni_retry_request(1),
   } ServerESNIResponseType;

   struct {
       ServerESNIResponseType response_type;
       select (response_type) {
           case esni_accept:        uint8 nonce[16];
           case esni_retry_request: ESNIConfigs retry_configs;
       }
   } ServerEncryptedSNI;
</pre><a href="#section-5-7" class="pilcrow">¶</a>
</div>
<dl class="dlParallel" id="section-5-8">
        <dt id="section-5-8.1">response_type</dt>
<dd id="section-5-8.2">
  Indicates whether the server processed the client ESNI extension. (See
<a href="#handle-server-response" class="xref">Section 5.1.2</a> and <a href="#server-behavior" class="xref">Section 5.2</a>.}<a href="#section-5-8.2" class="pilcrow">¶</a>
</dd>
<dt id="section-5-8.3">nonce</dt>
<dd id="section-5-8.4">
  The contents of ClientESNIInner.nonce. (See <a href="#client-behavior" class="xref">Section 5.1</a>.)<a href="#section-5-8.4" class="pilcrow">¶</a>
</dd>
<dt id="section-5-8.5">retry_configs</dt>
<dd id="section-5-8.6">
  One or more ESNIConfig structures containing the keys that the client should use on
subsequent connections to encrypt the ClientESNIInner structure.<a href="#section-5-8.6" class="pilcrow">¶</a>
</dd>
</dl>
<p id="section-5-9">This protocol also defines the "esni_required" alert, which is sent by the
client when it offered an "encrypted_server_name" extension which was not
accepted by the server.<a href="#section-5-9" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-10">
<pre>
   enum {
       esni_required(121),
   } AlertDescription;
</pre><a href="#section-5-10" class="pilcrow">¶</a>
</div>
<p id="section-5-11">Finally, requirements in <a href="#client-behavior" class="xref">Section 5.1</a> and <a href="#server-behavior" class="xref">Section 5.2</a> require
implementations to track, alongside each PSK established by a previous
connection, whether the connection negotiated this extension with the
"esni_accept" response type. If so, this is referred to as an "ESNI PSK".
Otherwise, it is a "non-ESNI PSK". This may be implemented by adding a new field
to client and server session states.<a href="#section-5-11" class="pilcrow">¶</a></p>
<div id="client-behavior">
<section id="section-5.1">
        <h3 id="name-client-behavior">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-client-behavior" class="section-name selfRef">Client Behavior</a>
        </h3>
<div id="send-esni">
<section id="section-5.1.1">
          <h4 id="name-sending-an-encrypted-sni">
<a href="#section-5.1.1" class="section-number selfRef">5.1.1. </a><a href="#name-sending-an-encrypted-sni" class="section-name selfRef">Sending an encrypted SNI</a>
          </h4>
<p id="section-5.1.1-1">In order to send an encrypted SNI, the client MUST first select one of the
ESNIConfig values in the ESNIConfigs structure which it is able to process (see
<a href="#esni-configuration" class="xref">Section 4</a>). It then generates an (EC)DHE share in the
matching group. This share will then be sent to the server in the
"encrypted_server_name" extension and used to derive the SNI encryption key. It does not affect the
(EC)DHE shared secret used in the TLS key schedule. The client MUST also select
an appropriate cipher suite from the list of suites offered by the
server. If the client is unable to select an appropriate group or suite it
SHOULD ignore that ESNIConfig value and MAY attempt to use another value provided
by the server. The client MUST NOT send encrypted SNI using groups or cipher suites
not advertised by the server.<a href="#section-5.1.1-1" class="pilcrow">¶</a></p>
<p id="section-5.1.1-2">When offering an encrypted SNI, the client MUST NOT offer to resume any non-ESNI
PSKs. It additionally MUST NOT offer to resume any sessions for TLS 1.2 or
below.<a href="#section-5.1.1-2" class="pilcrow">¶</a></p>
<p id="section-5.1.1-3">Let Z be the DH shared secret derived from a key share in ESNIConfig and the
corresponding client share in ClientEncryptedSNI.key_share. The SNI encryption key is
computed from Z as follows:<a href="#section-5.1.1-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.1.1-4">
<pre>
   Zx = HKDF-Extract(0, Z)
   key = HKDF-Expand-Label(Zx, KeyLabel, Hash(ESNIContents), key_length)
   iv = HKDF-Expand-Label(Zx, IVLabel, Hash(ESNIContents), iv_length)
</pre><a href="#section-5.1.1-4" class="pilcrow">¶</a>
</div>
<p id="section-5.1.1-5">where ESNIContents is as specified below and Hash is the hash function
associated with the HKDF instantiation. The salt argument for HKDF-Extract is a
string consisting of Hash.length bytes set to zeros. For a client's first
ClientHello, KeyLabel = "esni key" and IVLabel = "esni iv", whereas for a
client's second ClientHello, sent in response to a HelloRetryRequest,
KeyLabel = "hrr esni key" and IVLabel = "hrr esni iv". (This label variance
is done to prevent nonce re-use since the client's ESNI key share, and
thus the value of Zx, does not change across ClientHello retries.)<a href="#section-5.1.1-5" class="pilcrow">¶</a></p>
<p id="section-5.1.1-6">Note that ESNIContents will not be directly transmitted to the server in the
ClientHello. The server will instead reconstruct the same object by obtaining
its values from ClientEncryptedSNI and ClientHello.<a href="#section-5.1.1-6" class="pilcrow">¶</a></p>
<p id="section-5.1.1-7">[[TODO: label swapping fixes a bug in the spec, though this may not be
the best way to deal with HRR. See https://github.com/tlswg/draft-ietf-tls-esni/issues/121
and https://github.com/tlswg/draft-ietf-tls-esni/pull/170 for more details.]]<a href="#section-5.1.1-7" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.1.1-8">
<pre>
   struct {
       opaque record_digest&lt;0..2^16-1&gt;;
       KeyShareEntry esni_key_share;
       Random client_hello_random;
   } ESNIContents;
</pre><a href="#section-5.1.1-8" class="pilcrow">¶</a>
</div>
<dl class="dlParallel" id="section-5.1.1-9">
            <dt id="section-5.1.1-9.1">record_digest</dt>
<dd id="section-5.1.1-9.2">
  Same value as ClientEncryptedSNI.record_digest.<a href="#section-5.1.1-9.2" class="pilcrow">¶</a>
</dd>
<dt id="section-5.1.1-9.3">esni_key_share</dt>
<dd id="section-5.1.1-9.4">
  Same value as ClientEncryptedSNI.key_share.<a href="#section-5.1.1-9.4" class="pilcrow">¶</a>
</dd>
<dt id="section-5.1.1-9.5">client_hello_random</dt>
<dd id="section-5.1.1-9.6">
  Same nonce as ClientHello.random.<a href="#section-5.1.1-9.6" class="pilcrow">¶</a>
</dd>
</dl>
<p id="section-5.1.1-10">The client then creates a ClientESNIInner structure:<a href="#section-5.1.1-10" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.1.1-11">
<pre>
   struct {
       opaque dns_name&lt;1..2^16-1&gt;;
       opaque zeros[ESNIConfigContents.padded_length - length(dns_name)];
   } PaddedServerNameList;

   struct {
       uint8 nonce[16];
       PaddedServerNameList realSNI;
   } ClientESNIInner;
</pre><a href="#section-5.1.1-11" class="pilcrow">¶</a>
</div>
<dl class="dlParallel" id="section-5.1.1-12">
            <dt id="section-5.1.1-12.1">nonce</dt>
<dd id="section-5.1.1-12.2">
  A random 16-octet value to be echoed by the server in the
"encrypted_server_name" extension.<a href="#section-5.1.1-12.2" class="pilcrow">¶</a>
</dd>
<dt id="section-5.1.1-12.3">dns_name</dt>
<dd id="section-5.1.1-12.4">
  The true SNI DNS name, that is, the HostName value that would have been sent in the
plaintext "server_name" extension. (NameType values other than "host_name" are
unsupported since SNI extensibility failed <span>[<a href="#SNIExtensibilityFailed" class="xref">SNIExtensibilityFailed</a>]</span>).<a href="#section-5.1.1-12.4" class="pilcrow">¶</a>
</dd>
<dt id="section-5.1.1-12.5">zeros</dt>
<dd id="section-5.1.1-12.6">
  Zero padding whose length makes the serialized PaddedServerNameList
struct have a length equal to ESNIConfigContents.padded_length.<a href="#section-5.1.1-12.6" class="pilcrow">¶</a>
</dd>
</dl>
<p id="section-5.1.1-13">This value consists of the serialized ServerNameList from the "server_name" extension,
padded with enough zeroes to make the total structure ESNIConfigContents.padded_length
bytes long. The purpose of the padding is to prevent attackers
from using the length of the "encrypted_server_name" extension
to determine the true SNI. If the serialized ServerNameList is
longer than ESNIConfigContents.padded_length, the client MUST NOT use
the "encrypted_server_name" extension.<a href="#section-5.1.1-13" class="pilcrow">¶</a></p>
<p id="section-5.1.1-14">The ClientEncryptedSNI.encrypted_sni value is then computed using
AEAD-Encrypt (<span>[<a href="#RFC5116" class="xref">RFC5116</a>]</span>; Section 2.1) with the AEAD corresponding to
ClientEncryptedSNI.suite as follows:<a href="#section-5.1.1-14" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.1.1-15">
<pre>
    encrypted_sni = AEAD-Encrypt(key, iv, KeyShareClientHello, ClientESNIInner)
</pre><a href="#section-5.1.1-15" class="pilcrow">¶</a>
</div>
<p id="section-5.1.1-16">Where KeyShareClientHello is the "extension_data" field of the "key_share"
extension in a Client Hello (Section 4.2.8 of <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>)). Including
KeyShareClientHello in the AAD of AEAD-Encrypt binds the ClientEncryptedSNI
value to the ClientHello and prevents cut-and-paste attacks.<a href="#section-5.1.1-16" class="pilcrow">¶</a></p>
<p id="section-5.1.1-17">Note: future extensions may end up reusing the server's KeyShareEntry
for other purposes within the same message (e.g., encrypting other
values). Those usages MUST have their own HKDF labels to avoid
reuse.<a href="#section-5.1.1-17" class="pilcrow">¶</a></p>
<p id="section-5.1.1-18">[[OPEN ISSUE: If in the future you were to reuse these keys for
0-RTT priming, then you would have to worry about potentially
expanding twice of Z_extracted. We should think about how
to harmonize these to make sure that we maintain key separation.]]<a href="#section-5.1.1-18" class="pilcrow">¶</a></p>
<p id="section-5.1.1-19">This value is placed in an "encrypted_server_name" extension.<a href="#section-5.1.1-19" class="pilcrow">¶</a></p>
<p id="section-5.1.1-20">The client MUST place the value of ESNIConfigContents.public_name in the "server_name"
extension. (This is required for technical conformance with <span>[<a href="#RFC7540" class="xref">RFC7540</a>]</span>;
Section 9.2.) The client MUST NOT send a "cached_info" extension <span>[<a href="#RFC7924" class="xref">RFC7924</a>]</span>
with a CachedObject entry whose CachedInformationType is "cert", since this
indication would divulge the true server name.<a href="#section-5.1.1-20" class="pilcrow">¶</a></p>
</section>
</div>
<div id="handle-server-response">
<section id="section-5.1.2">
          <h4 id="name-handling-the-server-respons">
<a href="#section-5.1.2" class="section-number selfRef">5.1.2. </a><a href="#name-handling-the-server-respons" class="section-name selfRef">Handling the server response</a>
          </h4>
<p id="section-5.1.2-1">If the server negotiates TLS 1.3 or above and provides an
"encrypted_server_name" extension in EncryptedExtensions, the client
then processes the extension's "response_type" field:<a href="#section-5.1.2-1" class="pilcrow">¶</a></p>
<ul>
<li id="section-5.1.2-2.1">If the value is "esni_accept", the client MUST check that the extension's
"nonce" field matches ClientESNIInner.nonce and otherwise abort the
connection with an "illegal_parameter" alert. The client then proceeds
with the connection as usual, authenticating the connection for the origin
server.<a href="#section-5.1.2-2.1" class="pilcrow">¶</a>
</li>
<li id="section-5.1.2-2.2">
              <p id="section-5.1.2-2.2.1">If the value is "esni_retry_request", the client proceeds with the handshake,
authenticating for ESNIConfigContents.public_name as described in
<a href="#auth-public-name" class="xref">Section 5.1.3</a>. If authentication or the handshake fails, the client
MUST return a failure to the calling application. It MUST NOT use the retry
keys.<a href="#section-5.1.2-2.2.1" class="pilcrow">¶</a></p>
<p id="section-5.1.2-2.2.2">
Otherwise, when the handshake completes successfully with the public name
authenticated, the client MUST abort the connection with an "esni_required"
alert. It then processes the "retry_keys" field from the server's
"encrypted_server_name" extension.<a href="#section-5.1.2-2.2.2" class="pilcrow">¶</a></p>
<p id="section-5.1.2-2.2.3">
If one of the values contains a version supported by the client, it can regard
the ESNI keys as securely replaced by the server. It SHOULD retry the
handshake with a new transport connection, using that value to encrypt the
SNI. The value may only be applied to the retry connection. The client
MUST continue to use the previously-advertised keys for subsequent
connections. This avoids introducing pinning concerns or a tracking vector,
should a malicious server present client-specific retry keys to identify
clients.<a href="#section-5.1.2-2.2.3" class="pilcrow">¶</a></p>
<p id="section-5.1.2-2.2.4">
If none of the values provided in "retry_keys" contains a supported version,
the client can regard ESNI as securely disabled by the server. As below, it
SHOULD then retry the handshake with a new transport connection and ESNI
disabled.<a href="#section-5.1.2-2.2.4" class="pilcrow">¶</a></p>
</li>
<li id="section-5.1.2-2.3">If the field contains any other value, the client MUST abort the connection
with an "illegal_parameter" alert.<a href="#section-5.1.2-2.3" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-5.1.2-3">If the server negotiates an earlier version of TLS, or if it does not
provide an "encrypted_server_name" extension in EncryptedExtensions, the
client proceeds with the handshake, authenticating for
ESNIConfigContents.public_name as described in <a href="#auth-public-name" class="xref">Section 5.1.3</a>. If an earlier
version was negotiated, the client MUST NOT enable the False Start optimization
<span>[<a href="#RFC7918" class="xref">RFC7918</a>]</span> for this handshake. If authentication or the handshake fails, the
client MUST return a failure to the calling application. It MUST NOT treat this
as a secure signal to disable ESNI.<a href="#section-5.1.2-3" class="pilcrow">¶</a></p>
<p id="section-5.1.2-4">Otherwise, when the handshake completes successfully with the public name
authenticated, the client MUST abort the connection with an "esni_required"
alert. The client can then regard ESNI as securely disabled by the server. It
SHOULD retry the handshake with a new transport connection and ESNI disabled.<a href="#section-5.1.2-4" class="pilcrow">¶</a></p>
<p id="section-5.1.2-5">[[TODO: Key replacement is significantly less scary than saying that ESNI-naive
  servers bounce ESNI off. Is it worth defining a strict mode toggle in the ESNI
  keys, for a deployment to indicate it is ready for that? ]]<a href="#section-5.1.2-5" class="pilcrow">¶</a></p>
<p id="section-5.1.2-6">Clients SHOULD implement a limit on retries caused by "esni_retry_request" or
servers which do not acknowledge the "encrypted_server_name" extension. If the
client does not retry in either scenario, it MUST report an error to the
calling application.<a href="#section-5.1.2-6" class="pilcrow">¶</a></p>
<p id="section-5.1.2-7">If the server sends a HelloRetryRequest in response to the ClientHello
and the client can send a second updated ClientHello per the rules in
<span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, the "encrypted_server_name" extension values which do not depend
on the (possibly updated) KeyShareClientHello, i.e,,
ClientEncryptedSNI.suite, ClientEncryptedSNI.key_share, and
ClientEncryptedSNI.record_digest, MUST NOT change across ClientHello messages.
Moreover, ClientESNIInner MUST not change across ClientHello messages.
Informally, the values of all unencrypted extension information, as well as
the inner extension plaintext, must be consistent between the first and
second ClientHello messages.<a href="#section-5.1.2-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="auth-public-name">
<section id="section-5.1.3">
          <h4 id="name-authenticating-for-the-publ">
<a href="#section-5.1.3" class="section-number selfRef">5.1.3. </a><a href="#name-authenticating-for-the-publ" class="section-name selfRef">Authenticating for the public name</a>
          </h4>
<p id="section-5.1.3-1">When the server cannot decrypt or does not process the "encrypted_server_name"
extension, it continues with the handshake using the cleartext "server_name"
extension instead (see <a href="#server-behavior" class="xref">Section 5.2</a>). Clients that offer ESNI then
authenticate the connection with the public name, as follows:<a href="#section-5.1.3-1" class="pilcrow">¶</a></p>
<ul>
<li id="section-5.1.3-2.1">If the server resumed a session or negotiated a session that did not use a
certificate for authentication, the client MUST abort the connection with an
"illegal_parameter" alert. This case is invalid because <a href="#send-esni" class="xref">Section 5.1.1</a> requires
the client to only offer ESNI-established sessions, and <a href="#server-behavior" class="xref">Section 5.2</a>
requires the server to decline ESNI-established sessions if it did not accept
ESNI.<a href="#section-5.1.3-2.1" class="pilcrow">¶</a>
</li>
<li id="section-5.1.3-2.2">The client MUST verify that the certificate is valid for ESNIConfigContents.public_name.
If invalid, it MUST abort the connection with the appropriate alert.<a href="#section-5.1.3-2.2" class="pilcrow">¶</a>
</li>
<li id="section-5.1.3-2.3">If the server requests a client certificate, the client MUST respond with an
empty Certificate message, denoting no client certificate.<a href="#section-5.1.3-2.3" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-5.1.3-3">Note that authenticating a connection for the public name does not authenticate
it for the origin. The TLS implementation MUST NOT report such connections as
successful to the application. It additionally MUST ignore all session tickets
and session IDs presented by the server. These connections are only used to
trigger retries, as described in <a href="#handle-server-response" class="xref">Section 5.1.2</a>. This may be
implemented, for instance, by reporting a failed connection with a dedicated
error code.<a href="#section-5.1.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="grease-extensions">
<section id="section-5.1.4">
          <h4 id="name-grease-extensions">
<a href="#section-5.1.4" class="section-number selfRef">5.1.4. </a><a href="#name-grease-extensions" class="section-name selfRef">GREASE extensions</a>
          </h4>
<p id="section-5.1.4-1">If the client attempts to connect to a server and does not have an ESNIConfigs
structure available for the server or was unable to select an appropriate
ESNIConfig value, it SHOULD send a GREASE <span>[<a href="#I-D.ietf-tls-grease" class="xref">I-D.ietf-tls-grease</a>]</span>
"encrypted_server_name" extension as follows:<a href="#section-5.1.4-1" class="pilcrow">¶</a></p>
<ul>
<li id="section-5.1.4-2.1">Select a supported cipher suite, named group, and padded_length
value. The padded_length value SHOULD be 260 (sum of the maximum DNS name
length and TLS encoding overhead) or a multiple of 16 less than 260.
Set the "suite" field  to the selected cipher suite. These selections
SHOULD vary to exercise all supported configurations, but MAY be held constant
for successive connections to the same server in the same session.<a href="#section-5.1.4-2.1" class="pilcrow">¶</a>
</li>
<li id="section-5.1.4-2.2">Set the "key_share" field to a randomly-generated valid public key
for the named group.<a href="#section-5.1.4-2.2" class="pilcrow">¶</a>
</li>
<li id="section-5.1.4-2.3">Set the "record_digest" field to a randomly-generated string of hash_length
bytes, where hash_length is the length of the hash function associated with
the chosen cipher suite.<a href="#section-5.1.4-2.3" class="pilcrow">¶</a>
</li>
<li id="section-5.1.4-2.4">Set the "encrypted_sni" field to a randomly-generated string of
16 + padded_length + tag_length bytes, where tag_length is the tag length
of the chosen cipher suite's associated AEAD.<a href="#section-5.1.4-2.4" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-5.1.4-3">If the server sends an "encrypted_server_name" extension, the client
MUST check the extension syntactically and abort the connection with a
"decode_error" alert if it is invalid. If the "response_type" field
contains "esni_retry_requested", the client MUST ignore the extension
and proceed with the handshake. If it contains "esni_accept" or any other
value, the client MUST abort the connection with an "illegal_parameter" alert.<a href="#section-5.1.4-3" class="pilcrow">¶</a></p>
<p id="section-5.1.4-4">Offering a GREASE extension is not considered offering an encrypted SNI for
purposes of requirements in <a href="#client-behavior" class="xref">Section 5.1</a>. In particular, the client MAY
offer to resume sessions established without ESNI.<a href="#section-5.1.4-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="server-behavior">
<section id="section-5.2">
        <h3 id="name-client-facing-server-behavi">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-client-facing-server-behavi" class="section-name selfRef">Client-Facing Server Behavior</a>
        </h3>
<p id="section-5.2-1">Upon receiving an "encrypted_server_name" extension, the client-facing
server MUST check that it is able to negotiate TLS 1.3 or greater. If not,
it MUST abort the connection with a "handshake_failure" alert.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2-2">The ClientEncryptedSNI value is said to match a known ESNIConfig if there exists
an ESNIConfig that can be used to successfully decrypt ClientEncryptedSNI.encrypted_sni.
This matching procedure should be done using one of the following two checks:<a href="#section-5.2-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal" id="section-5.2-3">
          <li id="section-5.2-3.1">Compare ClientEncryptedSNI.record_digest against cryptographic hashes of known ESNIConfig
and choose the one that matches.<a href="#section-5.2-3.1" class="pilcrow">¶</a>
</li>
<li id="section-5.2-3.2">Use trial decryption of ClientEncryptedSNI.encrypted_sni with known ESNIConfig and choose
the one that succeeds.<a href="#section-5.2-3.2" class="pilcrow">¶</a>
</li>
</ol>
<p id="section-5.2-4">Some uses of ESNI, such as local discovery mode, may omit the ClientEncryptedSNI.record_digest
since it can be used as a tracking vector. In such cases, trial decryption should be
used for matching ClientEncryptedSNI to known ESNIConfig. Unless specified by the application
using (D)TLS or externally configured on both sides, implementations MUST use the first method.<a href="#section-5.2-4" class="pilcrow">¶</a></p>
<p id="section-5.2-5">If the ClientEncryptedSNI value does not match any known ESNIConfig
structure, it MUST ignore the extension and proceed with the connection,
with the following added behavior:<a href="#section-5.2-5" class="pilcrow">¶</a></p>
<ul>
<li id="section-5.2-6.1">It MUST include the "encrypted_server_name" extension in
EncryptedExtensions message with the "response_type" field set to
"esni_retry_requested" and the "retry_configs" field set to an up-to-date
ESNIConfigs structure.<a href="#section-5.2-6.1" class="pilcrow">¶</a>
</li>
<li id="section-5.2-6.2">The server MUST ignore all PSK identities in the ClientHello which correspond
to ESNI PSKs. ESNI PSKs offered by the client are associated with the ESNI
name. The server was unable to decrypt then ESNI name, so it should not resume
them when using the cleartext SNI name. This restriction allows a client to
reject resumptions in <a href="#auth-public-name" class="xref">Section 5.1.3</a>.<a href="#section-5.2-6.2" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-5.2-7">Note that an unrecognized ClientEncryptedSNI.record_digest value may be
a GREASE ESNI extension (see <a href="#grease-extensions" class="xref">Section 5.1.4</a>), so it is necessary
for servers to proceed with the connection and rely on the client to abort if
ESNI was required. In particular, the unrecognized value alone does not
indicate a misconfigured ESNI advertisement (<a href="#misconfiguration" class="xref">Section 6.1</a>). Instead,
servers can measure occurrences of the "esni_required" alert to detect this
case.<a href="#section-5.2-7" class="pilcrow">¶</a></p>
<p id="section-5.2-8">If the ClientEncryptedSNI value does match a known ESNIConfig, the server
performs the following checks:<a href="#section-5.2-8" class="pilcrow">¶</a></p>
<ul>
<li id="section-5.2-9.1">If the ClientEncryptedSNI.key_share group does not match ESNIConfigContents.key,
it MUST abort the connection with an "illegal_parameter" alert.<a href="#section-5.2-9.1" class="pilcrow">¶</a>
</li>
<li id="section-5.2-9.2">If the length of the "encrypted_server_name" extension is
inconsistent with the advertised padding length (plus AEAD
expansion) the server MAY abort the connection with an
"illegal_parameter" alert without attempting to decrypt.<a href="#section-5.2-9.2" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-5.2-10">Assuming these checks succeed, the server then computes K_sni
and decrypts the ServerName value. If decryption fails, the server
MUST abort the connection with a "decrypt_error" alert.<a href="#section-5.2-10" class="pilcrow">¶</a></p>
<p id="section-5.2-11">If the decrypted value's length is different from
the advertised ESNIConfigContents.padded_length or the padding consists of
any value other than 0, then the server MUST abort the
connection with an "illegal_parameter" alert. Otherwise, the
server uses the PaddedServerNameList.sni value as if it were
the "server_name" extension. Any actual "server_name" extension is
ignored, which also means the server MUST NOT send the "server_name"
extension to the client.<a href="#section-5.2-11" class="pilcrow">¶</a></p>
<p id="section-5.2-12">Upon determining the true SNI, the client-facing server then either
serves the connection directly (if in Shared Mode), in which case
it executes the steps in the following section, or forwards
the TLS connection to the backend server (if in Split Mode). In
the latter case, it does not make any changes to the TLS
messages, but just blindly forwards them.<a href="#section-5.2-12" class="pilcrow">¶</a></p>
<p id="section-5.2-13">If the ClientHello is the result of a HelloRetryRequest, servers MUST
abort the connection with an "illegal_parameter" alert if any of the
ClientEncryptedSNI.suite, ClientEncryptedSNI.key_share, ClientEncryptedSNI.record_digest,
or decrypted ClientESNIInner values from the second ClientHello do not
match that of the first ClientHello.<a href="#section-5.2-13" class="pilcrow">¶</a></p>
</section>
</div>
<div id="shared-mode-server-behavior">
<section id="section-5.3">
        <h3 id="name-shared-mode-server-behavior">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-shared-mode-server-behavior" class="section-name selfRef">Shared Mode Server Behavior</a>
        </h3>
<p id="section-5.3-1">A server operating in Shared Mode uses PaddedServerNameList.sni as
if it were the "server_name" extension to finish the handshake. It
SHOULD pad the Certificate message, via padding at the record layer,
such that its length equals the size of the largest possible Certificate
(message) covered by the same ESNI key. Moreover, the server MUST
include the "encrypted_server_name" extension in EncryptedExtensions
with the "response_type" field set to "esni_accept" and the "nonce"
field set to the decrypted PaddedServerNameList.nonce value from the client
"encrypted_server_name" extension.<a href="#section-5.3-1" class="pilcrow">¶</a></p>
<p id="section-5.3-2">If the server sends a NewSessionTicket message, the corresponding ESNI PSK MUST
be ignored by all other servers in the deployment when not negotiating ESNI,
including servers which do not implement this specification.<a href="#section-5.3-2" class="pilcrow">¶</a></p>
<p id="section-5.3-3">This restriction provides robustness for rollbacks (see <a href="#misconfiguration" class="xref">Section 6.1</a>).<a href="#section-5.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="backend-server-behavior">
<section id="section-5.4">
        <h3 id="name-split-mode-server-behavior">
<a href="#section-5.4" class="section-number selfRef">5.4. </a><a href="#name-split-mode-server-behavior" class="section-name selfRef">Split Mode Server Behavior</a>
        </h3>
<p id="section-5.4-1">In Split Mode, the backend server must know PaddedServerNameList.nonce
to echo it back in EncryptedExtensions and complete the handshake.
<a href="#communicating-sni" class="xref">Section 9</a> describes one mechanism for sending both
PaddedServerNameList.sni and ClientESNIInner.nonce to the backend
server. Thus, backend servers function the same as servers operating
in Shared Mode.<a href="#section-5.4-1" class="pilcrow">¶</a></p>
<p id="section-5.4-2">As in Shared Mode, if the backend server sends a NewSessionTicket message, the
corresponding ESNI PSK MUST be ignored by other servers in the deployment when
not negotiating ESNI, including servers which do not implement this
specification.<a href="#section-5.4-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="compatibility-issues">
<section id="section-6">
      <h2 id="name-compatibility-issues">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-compatibility-issues" class="section-name selfRef">Compatibility Issues</a>
      </h2>
<p id="section-6-1">Unlike most TLS extensions, placing the SNI value in an ESNI extension
is not interoperable with existing servers, which expect the value in
the existing cleartext extension. Thus server operators SHOULD ensure
servers understand a given set of ESNI keys before advertising them.
Additionally, servers SHOULD retain support for any
previously-advertised keys for the duration of their validity.<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">However, in more complex deployment scenarios, this may be difficult
to fully guarantee. Thus this protocol was designed to be robust in case
of inconsistencies between systems that advertise ESNI keys and servers, at the
cost of extra round-trips due to a retry. Two specific scenarios are detailed
below.<a href="#section-6-2" class="pilcrow">¶</a></p>
<div id="misconfiguration">
<section id="section-6.1">
        <h3 id="name-misconfiguration-and-deploy">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-misconfiguration-and-deploy" class="section-name selfRef">Misconfiguration and Deployment Concerns</a>
        </h3>
<p id="section-6.1-1">It is possible for ESNI advertisements and servers to become inconsistent. This
may occur, for instance, from DNS misconfiguration, caching issues, or an
incomplete rollout in a multi-server deployment. This may also occur if a server
loses its ESNI keys, or if a deployment of ESNI must be rolled back on the
server.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<p id="section-6.1-2">The retry mechanism repairs inconsistencies, provided the server is
authoritative for the public name. If server and advertised keys mismatch,
the server will respond with esni_retry_requested. If the server does not understand the
"encrypted_server_name" extension at all, it will ignore it as required by <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>;
Section 4.1.2. Provided the server can present a certificate valid for the public name,
the client can safely retry with updated settings, as described in <a href="#handle-server-response" class="xref">Section 5.1.2</a>.<a href="#section-6.1-2" class="pilcrow">¶</a></p>
<p id="section-6.1-3">Unless ESNI is disabled as a result of successfully establishing a connection to
the public name, the client MUST NOT fall back to cleartext SNI, as this allows
a network attacker to disclose the SNI.  It MAY attempt to use another server
from the DNS results, if one is provided.<a href="#section-6.1-3" class="pilcrow">¶</a></p>
<p id="section-6.1-4">Client-facing servers with non-uniform cryptographic configurations across backend
origin servers segment the ESNI anonymity set based on these configurations. For example,
if a client-facing server hosts k backend origin servers, and exactly one of those
backend origin servers supports a different set of cryptographic algorithms than the
other (k - 1) servers, it may be possible to identify this single server based on
the contents of the ServerHello as this message is not encrypted.<a href="#section-6.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="middleboxes">
<section id="section-6.2">
        <h3 id="name-middleboxes">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-middleboxes" class="section-name selfRef">Middleboxes</a>
        </h3>
<p id="section-6.2-1">A more serious problem is MITM proxies which do not support this
extension. <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>; Section 9.3 requires that
such proxies remove any extensions they do not understand. The handshake will
then present a certificate based on the public name, without echoing the
"encrypted_server_name" extension to the client.<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<p id="section-6.2-2">Depending on whether the client is configured to accept the proxy's certificate
as authoritative for the public name, this may trigger the retry logic described
in <a href="#handle-server-response" class="xref">Section 5.1.2</a> or result in a connection failure. A proxy which
is not authoritative for the public name cannot forge a signal to disable ESNI.<a href="#section-6.2-2" class="pilcrow">¶</a></p>
<p id="section-6.2-3">A non-conformant MITM proxy which instead forwards the ESNI extension,
substituting its own KeyShare value, will result in
the client-facing server recognizing the key, but failing to decrypt
the SNI. This causes a hard failure. Clients SHOULD NOT attempt to repair the
connection in this case.<a href="#section-6.2-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-7">
      <h2 id="name-security-considerations">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<div id="cleartext-dns">
<section id="section-7.1">
        <h3 id="name-why-is-cleartext-dns-ok">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-why-is-cleartext-dns-ok" class="section-name selfRef">Why is cleartext DNS OK?</a>
        </h3>
<p id="section-7.1-1">In comparison to <span>[<a href="#I-D.kazuho-protected-sni" class="xref">I-D.kazuho-protected-sni</a>]</span>, wherein DNS Resource
Records are signed via a server private key, ESNI records have no
authenticity or provenance information. This means that any attacker
which can inject DNS responses or poison DNS caches, which is a common
scenario in client access networks, can supply clients with fake
ESNI records (so that the client encrypts SNI to them) or strip the
ESNI record from the response. However, in the face of an attacker that
controls DNS, no SNI encryption scheme can work because the attacker
can replace the IP address, thus blocking client connections, or
substituting a unique IP address which is 1:1 with the DNS name that
was looked up (modulo DNS wildcards). Thus, allowing the ESNI records in
the clear does not make the situation significantly worse.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1-2">Clearly, DNSSEC (if the client validates and hard fails) is a defense against
this form of attack, but DoH/DPRIVE are also defenses against DNS attacks
by attackers on the local network, which is a common case where SNI is
desired.
Moreover, as noted in the introduction, SNI encryption is less useful
without encryption of DNS queries in transit via DoH or DPRIVE mechanisms.<a href="#section-7.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="optional-record-digests-and-trial-decryption">
<section id="section-7.2">
        <h3 id="name-optional-record-digests-and">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-optional-record-digests-and" class="section-name selfRef">Optional Record Digests and Trial Decryption</a>
        </h3>
<p id="section-7.2-1">Supporting optional record digests and trial decryption opens oneself up to
DoS attacks. Specifically, an adversary may send malicious ClientHello messages, i.e.,
those which will not decrypt with any known ESNI key, in order to force
decryption. Servers that support this feature should, for example, implement
some form of rate limiting mechanism to limit the damage caused by such attacks.<a href="#section-7.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encrypting-other-extensions">
<section id="section-7.3">
        <h3 id="name-encrypting-other-extensions">
<a href="#section-7.3" class="section-number selfRef">7.3. </a><a href="#name-encrypting-other-extensions" class="section-name selfRef">Encrypting other Extensions</a>
        </h3>
<p id="section-7.3-1">ESNI protects only the SNI in transit. Other ClientHello extensions,
such as ALPN, might also reveal privacy-sensitive information to the
network. As such, it might be desirable to encrypt other extensions
alongside the SNI. However, the SNI extension is unique in that
non-TLS-terminating servers or load balancers may act on its contents.
Thus, using keys specifically for SNI encryption promotes key separation
between client-facing servers and endpoints party to TLS connections.
Moreover, the ESNI design described herein does not preclude a mechanism
for generic ClientHello extension encryption.<a href="#section-7.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="related-privacy-leaks">
<section id="section-7.4">
        <h3 id="name-related-privacy-leaks">
<a href="#section-7.4" class="section-number selfRef">7.4. </a><a href="#name-related-privacy-leaks" class="section-name selfRef">Related Privacy Leaks</a>
        </h3>
<p id="section-7.4-1">ESNI requires encrypted DNS to be an effective privacy protection mechanism.
However, verifying the server's identity from the Certificate message, particularly
when using the X509 CertificateType, may result in additional network traffic
that may reveal the server identity. Examples of this traffic may include requests
for revocation information, such as OCSP or CRL traffic, or requests for repository
information, such as authorityInformationAccess. It may also include
implementation-specific traffic for additional information sources as part of
verification.<a href="#section-7.4-1" class="pilcrow">¶</a></p>
<p id="section-7.4-2">Implementations SHOULD avoid leaking information that may identify the
server. Even when sent over an encrypted transport, such requests may result
in indirect exposure of the server's identity, such as indicating a specific CA
or service being used. To mitigate this risk, servers SHOULD deliver such
information in-band when possible, such as through the use of OCSP stapling,
and clients SHOULD take steps to minimize or protect such requests during
certificate validation.<a href="#section-7.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="comparison-against-criteria">
<section id="section-7.5">
        <h3 id="name-comparison-against-criteria">
<a href="#section-7.5" class="section-number selfRef">7.5. </a><a href="#name-comparison-against-criteria" class="section-name selfRef">Comparison Against Criteria</a>
        </h3>
<p id="section-7.5-1"><span>[<a href="#I-D.ietf-tls-sni-encryption" class="xref">I-D.ietf-tls-sni-encryption</a>]</span> lists several requirements for SNI
encryption. In this section, we re-iterate these requirements and assess
the ESNI design against them.<a href="#section-7.5-1" class="pilcrow">¶</a></p>
<div id="mitigate-against-replay-attacks">
<section id="section-7.5.1">
          <h4 id="name-mitigate-against-replay-att">
<a href="#section-7.5.1" class="section-number selfRef">7.5.1. </a><a href="#name-mitigate-against-replay-att" class="section-name selfRef">Mitigate against replay attacks</a>
          </h4>
<p id="section-7.5.1-1">Since the SNI encryption key is derived from a (EC)DH operation
between the client's ephemeral and server's semi-static ESNI key, the ESNI
encryption is bound to the Client Hello. It is not possible for
an attacker to "cut and paste" the ESNI value in a different Client
Hello, with a different ephemeral key share, as the terminating server
will fail to decrypt and verify the ESNI value.<a href="#section-7.5.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="avoid-widely-deployed-shared-secrets">
<section id="section-7.5.2">
          <h4 id="name-avoid-widely-deployed-share">
<a href="#section-7.5.2" class="section-number selfRef">7.5.2. </a><a href="#name-avoid-widely-deployed-share" class="section-name selfRef">Avoid widely-deployed shared secrets</a>
          </h4>
<p id="section-7.5.2-1">This design depends upon DNS as a vehicle for semi-static public key distribution.
Server operators may partition their private keys however they see fit provided
each server behind an IP address has the corresponding private key to decrypt
a key. Thus, when one ESNI key is provided, sharing is optimally bound by the number
of hosts that share an IP address. Server operators may further limit sharing
by publishing different DNS records containing ESNIConfig values with different
keys using a short TTL.<a href="#section-7.5.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="prevent-sni-based-dos-attacks">
<section id="section-7.5.3">
          <h4 id="name-prevent-sni-based-dos-attac">
<a href="#section-7.5.3" class="section-number selfRef">7.5.3. </a><a href="#name-prevent-sni-based-dos-attac" class="section-name selfRef">Prevent SNI-based DoS attacks</a>
          </h4>
<p id="section-7.5.3-1">This design requires servers to decrypt ClientHello messages with ClientEncryptedSNI
extensions carrying valid digests. Thus, it is possible for an attacker to force
decryption operations on the server. This attack is bound by the number of
valid TCP connections an attacker can open.<a href="#section-7.5.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="do-not-stick-out">
<section id="section-7.5.4">
          <h4 id="name-do-not-stick-out">
<a href="#section-7.5.4" class="section-number selfRef">7.5.4. </a><a href="#name-do-not-stick-out" class="section-name selfRef">Do not stick out</a>
          </h4>
<p id="section-7.5.4-1">As more clients enable ESNI support, e.g., as normal part of Web browser
functionality, with keys supplied by shared hosting providers, the presence
of ESNI extensions becomes less suspicious and part of common or predictable
client behavior. In other words, if all Web browsers start using ESNI,
the presence of this value does not signal suspicious behavior to passive
eavesdroppers.<a href="#section-7.5.4-1" class="pilcrow">¶</a></p>
<p id="section-7.5.4-2">Additionally, this specification allows for clients to send GREASE ESNI
extensions (see <a href="#grease-extensions" class="xref">Section 5.1.4</a>), which helps ensure the ecosystem
handles the values correctly.<a href="#section-7.5.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="forward-secrecy">
<section id="section-7.5.5">
          <h4 id="name-forward-secrecy">
<a href="#section-7.5.5" class="section-number selfRef">7.5.5. </a><a href="#name-forward-secrecy" class="section-name selfRef">Forward secrecy</a>
          </h4>
<p id="section-7.5.5-1">This design is not forward secret because the server's ESNI key is static.
However, the window of exposure is bound by the key lifetime. It is
RECOMMENDED that servers rotate keys frequently.<a href="#section-7.5.5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="proper-security-context">
<section id="section-7.5.6">
          <h4 id="name-proper-security-context">
<a href="#section-7.5.6" class="section-number selfRef">7.5.6. </a><a href="#name-proper-security-context" class="section-name selfRef">Proper security context</a>
          </h4>
<p id="section-7.5.6-1">This design permits servers operating in Split Mode to forward connections
directly to backend origin servers, thereby avoiding unnecessary MiTM attacks.<a href="#section-7.5.6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="split-server-spoofing">
<section id="section-7.5.7">
          <h4 id="name-split-server-spoofing">
<a href="#section-7.5.7" class="section-number selfRef">7.5.7. </a><a href="#name-split-server-spoofing" class="section-name selfRef">Split server spoofing</a>
          </h4>
<p id="section-7.5.7-1">Assuming ESNI records retrieved from DNS are authenticated, e.g., via DNSSEC or fetched
from a trusted Recursive Resolver, spoofing a server operating in Split Mode
is not possible. See <a href="#cleartext-dns" class="xref">Section 7.1</a> for more details regarding cleartext
DNS.<a href="#section-7.5.7-1" class="pilcrow">¶</a></p>
<p id="section-7.5.7-2">Authenticating the ESNIConfigs structure naturally authenticates the
included public name. This also authenticates any retry signals
from the server because the client validates the server
certificate against the public name before retrying.<a href="#section-7.5.7-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="supporting-multiple-protocols">
<section id="section-7.5.8">
          <h4 id="name-supporting-multiple-protoco">
<a href="#section-7.5.8" class="section-number selfRef">7.5.8. </a><a href="#name-supporting-multiple-protoco" class="section-name selfRef">Supporting multiple protocols</a>
          </h4>
<p id="section-7.5.8-1">This design has no impact on application layer protocol negotiation. It may affect
connection routing, server certificate selection, and client certificate verification.
Thus, it is compatible with multiple protocols.<a href="#section-7.5.8-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="misrouting">
<section id="section-7.6">
        <h3 id="name-misrouting">
<a href="#section-7.6" class="section-number selfRef">7.6. </a><a href="#name-misrouting" class="section-name selfRef">Misrouting</a>
        </h3>
<p id="section-7.6-1">Note that the backend server has no way of knowing what the SNI was,
but that does not lead to additional privacy exposure because the
backend server also only has one identity. This does, however, change
the situation slightly in that the backend server might previously have
checked SNI and now cannot (and an attacker can route a connection
with an encrypted SNI to any backend server and the TLS connection will
still complete).  However, the client is still responsible for
verifying the server's identity in its certificate.<a href="#section-7.6-1" class="pilcrow">¶</a></p>
<p id="section-7.6-2">[[TODO: Some more analysis needed in this case, as it is a little
odd, and probably some precise rules about handling ESNI and no
SNI uniformly?]]<a href="#section-7.6-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-8">
      <h2 id="name-iana-considerations">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<div id="update-of-the-tls-extensiontype-registry">
<section id="section-8.1">
        <h3 id="name-update-of-the-tls-extension">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-update-of-the-tls-extension" class="section-name selfRef">Update of the TLS ExtensionType Registry</a>
        </h3>
<p id="section-8.1-1">IANA is requested to create an entry, encrypted_server_name(0xffce),
in the existing registry for ExtensionType (defined in
<span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>), with "TLS 1.3" column values being set to
"CH, EE", and "Recommended" column being set to "Yes".<a href="#section-8.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="update-of-the-tls-alert-registry">
<section id="section-8.2">
        <h3 id="name-update-of-the-tls-alert-reg">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-update-of-the-tls-alert-reg" class="section-name selfRef">Update of the TLS Alert Registry</a>
        </h3>
<p id="section-8.2-1">IANA is requested to create an entry, esni_required(121) in the
existing registry for Alerts (defined in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>), with the
"DTLS-OK" column being set to "Y".<a href="#section-8.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="communicating-sni">
<section id="section-9">
      <h2 id="name-communicating-sni-and-nonce">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-communicating-sni-and-nonce" class="section-name selfRef">Communicating SNI and Nonce to Backend Server</a>
      </h2>
<p id="section-9-1">When operating in Split Mode, backend servers will not have access
to PaddedServerNameList.sni or ClientESNIInner.nonce without
access to the ESNI keys or a way to decrypt ClientEncryptedSNI.encrypted_sni.<a href="#section-9-1" class="pilcrow">¶</a></p>
<p id="section-9-2">One way to address this for a single connection, at the cost of having
communication not be unmodified TLS 1.3, is as follows.
Assume there is a shared (symmetric) key between the
client-facing server and the backend server and use it to AEAD-encrypt Z
and send the encrypted blob at the beginning of the connection before
the ClientHello. The backend server can then decrypt ESNI to recover
the true SNI and nonce.<a href="#section-9-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alternative-sni-protection-designs">
<section id="section-10">
      <h2 id="name-alternative-sni-protection-">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-alternative-sni-protection-" class="section-name selfRef">Alternative SNI Protection Designs</a>
      </h2>
<p id="section-10-1">Alternative approaches to encrypted SNI may be implemented at the TLS or
application layer. In this section we describe several alternatives and discuss
drawbacks in comparison to the design in this document.<a href="#section-10-1" class="pilcrow">¶</a></p>
<div id="tls-layer">
<section id="section-10.1">
        <h3 id="name-tls-layer">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-tls-layer" class="section-name selfRef">TLS-layer</a>
        </h3>
<div id="tls-in-early-data">
<section id="section-10.1.1">
          <h4 id="name-tls-in-early-data">
<a href="#section-10.1.1" class="section-number selfRef">10.1.1. </a><a href="#name-tls-in-early-data" class="section-name selfRef">TLS in Early Data</a>
          </h4>
<p id="section-10.1.1-1">In this variant, TLS Client Hellos are tunneled within early data payloads
belonging to outer TLS connections established with the client-facing server. This
requires clients to have established a previous session --- and obtained PSKs --- with
the server. The client-facing server decrypts early data payloads to uncover Client Hellos
destined for the backend server, and forwards them onwards as necessary. Afterwards, all
records to and from backend servers are forwarded by the client-facing server - unmodified.
This avoids double encryption of TLS records.<a href="#section-10.1.1-1" class="pilcrow">¶</a></p>
<p id="section-10.1.1-2">Problems with this approach are: (1) servers may not always be able to
distinguish inner Client Hellos from legitimate application data, (2) nested 0-RTT
data may not function correctly, (3) 0-RTT data may not be supported -
especially under DoS - leading to availability concerns, and (4) clients must bootstrap
tunnels (sessions), costing an additional round trip and potentially revealing the SNI
during the initial connection. In contrast, encrypted SNI protects the SNI in a distinct
Client Hello extension and neither abuses early data nor requires a bootstrapping connection.<a href="#section-10.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="combined-tickets">
<section id="section-10.1.2">
          <h4 id="name-combined-tickets">
<a href="#section-10.1.2" class="section-number selfRef">10.1.2. </a><a href="#name-combined-tickets" class="section-name selfRef">Combined Tickets</a>
          </h4>
<p id="section-10.1.2-1">In this variant, client-facing and backend servers coordinate to produce "combined tickets"
that are consumable by both. Clients offer combined tickets to client-facing servers.
The latter parse them to determine the correct backend server to which the Client Hello
should be forwarded. This approach is problematic due to non-trivial coordination between
client-facing and backend servers for ticket construction and consumption. Moreover,
it requires a bootstrapping step similar to that of the previous variant. In contrast,
encrypted SNI requires no such coordination.<a href="#section-10.1.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="application-layer">
<section id="section-10.2">
        <h3 id="name-application-layer">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-application-layer" class="section-name selfRef">Application-layer</a>
        </h3>
<div id="http2-certificate-frames">
<section id="section-10.2.1">
          <h4 id="name-http-2-certificate-frames">
<a href="#section-10.2.1" class="section-number selfRef">10.2.1. </a><a href="#name-http-2-certificate-frames" class="section-name selfRef">HTTP/2 CERTIFICATE Frames</a>
          </h4>
<p id="section-10.2.1-1">In this variant, clients request secondary certificates with CERTIFICATE_REQUEST HTTP/2
frames after TLS connection completion. In response, servers supply certificates via TLS
exported authenticators <span>[<a href="#I-D.ietf-tls-exported-authenticator" class="xref">I-D.ietf-tls-exported-authenticator</a>]</span> in CERTIFICATE frames.
Clients use a generic SNI for the underlying client-facing server TLS connection.
Problems with this approach include: (1) one additional round trip before peer
authentication, (2) non-trivial application-layer dependencies and interaction,
and (3) obtaining the generic SNI to bootstrap the connection. In contrast, encrypted
SNI induces no additional round trip and operates below the application layer.<a href="#section-10.2.1-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="total-client-hello-encryption">
<section id="section-11">
      <h2 id="name-total-client-hello-encrypti">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-total-client-hello-encrypti" class="section-name selfRef">Total Client Hello Encryption</a>
      </h2>
<p id="section-11-1">The design described here only provides encryption for the SNI, but
not for other extensions, such as ALPN. Another potential design
would be to encrypt all of the extensions using the same basic
structure as we use here for ESNI. That design has the following
advantages:<a href="#section-11-1" class="pilcrow">¶</a></p>
<ul>
<li id="section-11-2.1">It protects all the extensions from ordinary eavesdroppers<a href="#section-11-2.1" class="pilcrow">¶</a>
</li>
<li id="section-11-2.2">If the encrypted block has its own KeyShare, it does not
necessarily require the client to use a single KeyShare,
because the client's share is bound to the SNI by the
AEAD (analysis needed).<a href="#section-11-2.2" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-11-3">It also has the following disadvantages:<a href="#section-11-3" class="pilcrow">¶</a></p>
<ul>
<li id="section-11-4.1">The client-facing server can still see the other extensions. By
contrast we could introduce another EncryptedExtensions
block that was encrypted to the backend server and not
the client-facing server.<a href="#section-11-4.1" class="pilcrow">¶</a>
</li>
<li id="section-11-4.2">It requires a mechanism for the client-facing server to provide the
extension-encryption key to the backend server (as in <a href="#communicating-sni" class="xref">Section 9</a>
and thus cannot be used with an unmodified backend server.<a href="#section-11-4.2" class="pilcrow">¶</a>
</li>
<li id="section-11-4.3">A conformant middlebox will strip every extension, which might
result in a ClientHello which is just unacceptable to the server
(more analysis needed).<a href="#section-11-4.3" class="pilcrow">¶</a>
</li>
</ul>
</section>
</div>
<div id="acknowledgements">
<section id="section-12">
      <h2 id="name-acknowledgements">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-acknowledgements" class="section-name selfRef">Acknowledgements</a>
      </h2>
<p id="section-12-1">This document draws extensively from ideas in <span>[<a href="#I-D.kazuho-protected-sni" class="xref">I-D.kazuho-protected-sni</a>]</span>, but
is a much more limited mechanism because it depends on the DNS for the
protection of the ESNI key. Richard Barnes, Christian Huitema, Patrick McManus,
Matthew Prince, Nick Sullivan, Martin Thomson, and David Benjamin also provided
important ideas and contributions.<a href="#section-12-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-13">
      <h2 id="name-references">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-13.1">
        <h3 id="name-normative-references">
<a href="#section-13.1" class="section-number selfRef">13.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="HTTPSSVC">[HTTPSSVC]</dt>
<dd>
<span class="refAuthor">Schwartz, B.</span><span class="refAuthor">, Bishop, M.</span><span class="refAuthor">, and E. Nygren</span>, <span class="refTitle">"Service binding and parameter specification via the DNS (DNS SVCB and HTTPSSVC)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-nygren-dnsop-svcb-httpssvc-00</span>, <time datetime="2019-09-23">23 September 2019</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-nygren-dnsop-svcb-httpssvc-00.txt">http://www.ietf.org/internet-drafts/draft-nygren-dnsop-svcb-httpssvc-00.txt</a>&gt;</span>. </dd>
<dt id="I-D.ietf-tls-exported-authenticator">[I-D.ietf-tls-exported-authenticator]</dt>
<dd>
<span class="refAuthor">Sullivan, N.</span>, <span class="refTitle">"Exported Authenticators in TLS"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-tls-exported-authenticator-11</span>, <time datetime="2019-12-18">18 December 2019</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-tls-exported-authenticator-11.txt">http://www.ietf.org/internet-drafts/draft-ietf-tls-exported-authenticator-11.txt</a>&gt;</span>. </dd>
<dt id="RFC1035">[RFC1035]</dt>
<dd>
<span class="refAuthor">Mockapetris, P.V.</span>, <span class="refTitle">"Domain names - implementation and specification"</span>, <span class="seriesInfo">STD 13</span>, <span class="seriesInfo">RFC 1035</span>, <span class="seriesInfo">DOI 10.17487/RFC1035</span>, <time datetime="1987-11">November 1987</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc1035">https://www.rfc-editor.org/info/rfc1035</a>&gt;</span>. </dd>
<dt id="RFC2119">[RFC2119]</dt>
<dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dt id="RFC5116">[RFC5116]</dt>
<dd>
<span class="refAuthor">McGrew, D.</span>, <span class="refTitle">"An Interface and Algorithms for Authenticated Encryption"</span>, <span class="seriesInfo">RFC 5116</span>, <span class="seriesInfo">DOI 10.17487/RFC5116</span>, <time datetime="2008-01">January 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5116">https://www.rfc-editor.org/info/rfc5116</a>&gt;</span>. </dd>
<dt id="RFC6066">[RFC6066]</dt>
<dd>
<span class="refAuthor">Eastlake 3rd, D.</span>, <span class="refTitle">"Transport Layer Security (TLS) Extensions: Extension Definitions"</span>, <span class="seriesInfo">RFC 6066</span>, <span class="seriesInfo">DOI 10.17487/RFC6066</span>, <time datetime="2011-01">January 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6066">https://www.rfc-editor.org/info/rfc6066</a>&gt;</span>. </dd>
<dt id="RFC6234">[RFC6234]</dt>
<dd>
<span class="refAuthor">Eastlake 3rd, D.</span><span class="refAuthor"> and T. Hansen</span>, <span class="refTitle">"US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)"</span>, <span class="seriesInfo">RFC 6234</span>, <span class="seriesInfo">DOI 10.17487/RFC6234</span>, <time datetime="2011-05">May 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6234">https://www.rfc-editor.org/info/rfc6234</a>&gt;</span>. </dd>
<dt id="RFC7540">[RFC7540]</dt>
<dd>
<span class="refAuthor">Belshe, M.</span><span class="refAuthor">, Peon, R.</span><span class="refAuthor">, and M. Thomson, Ed.</span>, <span class="refTitle">"Hypertext Transfer Protocol Version 2 (HTTP/2)"</span>, <span class="seriesInfo">RFC 7540</span>, <span class="seriesInfo">DOI 10.17487/RFC7540</span>, <time datetime="2015-05">May 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7540">https://www.rfc-editor.org/info/rfc7540</a>&gt;</span>. </dd>
<dt id="RFC7918">[RFC7918]</dt>
<dd>
<span class="refAuthor">Langley, A.</span><span class="refAuthor">, Modadugu, N.</span><span class="refAuthor">, and B. Moeller</span>, <span class="refTitle">"Transport Layer Security (TLS) False Start"</span>, <span class="seriesInfo">RFC 7918</span>, <span class="seriesInfo">DOI 10.17487/RFC7918</span>, <time datetime="2016-08">August 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7918">https://www.rfc-editor.org/info/rfc7918</a>&gt;</span>. </dd>
<dt id="RFC7924">[RFC7924]</dt>
<dd>
<span class="refAuthor">Santesson, S.</span><span class="refAuthor"> and H. Tschofenig</span>, <span class="refTitle">"Transport Layer Security (TLS) Cached Information Extension"</span>, <span class="seriesInfo">RFC 7924</span>, <span class="seriesInfo">DOI 10.17487/RFC7924</span>, <time datetime="2016-07">July 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7924">https://www.rfc-editor.org/info/rfc7924</a>&gt;</span>. </dd>
<dt id="RFC8174">[RFC8174]</dt>
<dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dt id="RFC8446">[RFC8446]</dt>
<dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8446">https://www.rfc-editor.org/info/rfc8446</a>&gt;</span>. </dd>
</dl>
</section>
<section id="section-13.2">
        <h3 id="name-informative-references">
<a href="#section-13.2" class="section-number selfRef">13.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.ietf-doh-dns-over-https">[I-D.ietf-doh-dns-over-https]</dt>
<dd>
<span class="refAuthor">Hoffman, P.</span><span class="refAuthor"> and P. McManus</span>, <span class="refTitle">"DNS Queries over HTTPS (DoH)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-doh-dns-over-https-14</span>, <time datetime="2018-08-16">16 August 2018</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-doh-dns-over-https-14.txt">http://www.ietf.org/internet-drafts/draft-ietf-doh-dns-over-https-14.txt</a>&gt;</span>. </dd>
<dt id="I-D.ietf-tls-grease">[I-D.ietf-tls-grease]</dt>
<dd>
<span class="refAuthor">Benjamin, D.</span>, <span class="refTitle">"Applying GREASE to TLS Extensibility"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-tls-grease-04</span>, <time datetime="2019-08-22">22 August 2019</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-tls-grease-04.txt">http://www.ietf.org/internet-drafts/draft-ietf-tls-grease-04.txt</a>&gt;</span>. </dd>
<dt id="I-D.ietf-tls-sni-encryption">[I-D.ietf-tls-sni-encryption]</dt>
<dd>
<span class="refAuthor">Huitema, C.</span><span class="refAuthor"> and E. Rescorla</span>, <span class="refTitle">"Issues and Requirements for SNI Encryption in TLS"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-tls-sni-encryption-09</span>, <time datetime="2019-10-28">28 October 2019</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-tls-sni-encryption-09.txt">http://www.ietf.org/internet-drafts/draft-ietf-tls-sni-encryption-09.txt</a>&gt;</span>. </dd>
<dt id="I-D.kazuho-protected-sni">[I-D.kazuho-protected-sni]</dt>
<dd>
<span class="refAuthor">Oku, K.</span>, <span class="refTitle">"TLS Extensions for Protecting SNI"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-kazuho-protected-sni-00</span>, <time datetime="2017-07-18">18 July 2017</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-kazuho-protected-sni-00.txt">http://www.ietf.org/internet-drafts/draft-kazuho-protected-sni-00.txt</a>&gt;</span>. </dd>
<dt id="RFC7858">[RFC7858]</dt>
<dd>
<span class="refAuthor">Hu, Z.</span><span class="refAuthor">, Zhu, L.</span><span class="refAuthor">, Heidemann, J.</span><span class="refAuthor">, Mankin, A.</span><span class="refAuthor">, Wessels, D.</span><span class="refAuthor">, and P. Hoffman</span>, <span class="refTitle">"Specification for DNS over Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 7858</span>, <span class="seriesInfo">DOI 10.17487/RFC7858</span>, <time datetime="2016-05">May 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7858">https://www.rfc-editor.org/info/rfc7858</a>&gt;</span>. </dd>
<dt id="RFC8094">[RFC8094]</dt>
<dd>
<span class="refAuthor">Reddy, T.</span><span class="refAuthor">, Wing, D.</span><span class="refAuthor">, and P. Patil</span>, <span class="refTitle">"DNS over Datagram Transport Layer Security (DTLS)"</span>, <span class="seriesInfo">RFC 8094</span>, <span class="seriesInfo">DOI 10.17487/RFC8094</span>, <time datetime="2017-02">February 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8094">https://www.rfc-editor.org/info/rfc8094</a>&gt;</span>. </dd>
<dt id="SNIExtensibilityFailed">[SNIExtensibilityFailed]</dt>
<dd>
<span class="refTitle">"Accepting that other SNI name types will never work"</span>, <time datetime="2016-03">March 2016</time>, <span>&lt;<a href="https://mailarchive.ietf.org/arch/msg/tls/1t79gzNItZd71DwwoaqcQQ_4Yxc">https://mailarchive.ietf.org/arch/msg/tls/1t79gzNItZd71DwwoaqcQQ_4Yxc</a>&gt;</span>. </dd>
</dl>
</section>
</section>
<div id="authors-addresses">
<section id="section-appendix.a">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Eric Rescorla</span></div>
<div dir="auto" class="left"><span class="org">RTFM, Inc.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ekr@rtfm.com" class="email">ekr@rtfm.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Kazuho Oku</span></div>
<div dir="auto" class="left"><span class="org">Fastly</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:kazuhooku@gmail.com" class="email">kazuhooku@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Nick Sullivan</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:nick@cloudflare.com" class="email">nick@cloudflare.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christopher A. Wood</span></div>
<div dir="auto" class="left"><span class="org">Apple, Inc.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:cawood@apple.com" class="email">cawood@apple.com</a>
</div>
</address>
</section>
</div>
<script>var toc = document.getElementById("toc");
var tocToggle = toc.querySelector("h2");
var tocNav = toc.querySelector("nav");

// mobile menu toggle
tocToggle.onclick = function(event) {
    if (window.innerWidth < 1024) {
 var tocNavDisplay = tocNav.currentStyle ? tocNav.currentStyle.display : getComputedStyle(tocNav, null).display;
 if (tocNavDisplay == "none") {
     tocNav.style.display = "block";
 } else {
     tocNav.style.display = "none";
 }
    }
}

// toc anchor scroll to anchor
tocNav.addEventListener("click", function (event) {
    event.preventDefault();
    if (event.target.nodeName == 'A') {
 if (window.innerWidth < 1024) {
     tocNav.style.display = "none";
 }
 var href = event.target.getAttribute("href");
 var anchorId = href.substr(1);
 var anchor =  document.getElementById(anchorId);
 anchor.scrollIntoView(true);
 window.history.pushState("","",href);
    }
});

// switch toc mode when window resized
window.onresize = function () {
    if (window.innerWidth < 1024) {
 tocNav.style.display = "none";
    } else {
 tocNav.style.display = "block";
    }
}
</script>
</body>
</html>
